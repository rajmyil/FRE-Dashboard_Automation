#!/usr/bin/env bash

set -euo pipefail
readonly maven_install_json_loc=$BUILD_WORKSPACE_DIRECTORY/maven_install.json
# This script is run as a `sh_binary`, so ensure we are in the calling workspace before running Bazel.
readonly execution_root=$(cd "$(dirname "$maven_install_json_loc")" && bazel info execution_root)
readonly workspace_name=$(basename "$execution_root")
# `jq` is a platform-specific dependency with an unpredictable path.
# Note that $(rootpath) will always give external/unpinned_maven/jq, however under --nolegacy_external_runfiles
# there is only pin.runfiles/unpinned_maven/jq not also pin.runfiles/user_repo/external/unpinned_maven/jq
# So replace leading external/ with ../
readonly jq=${1/#external\//..\/}
cat <<"RULES_JVM_EXTERNAL_EOF" | "$jq" --sort-keys --indent 4 . - > $maven_install_json_loc
{ "dependency_tree": {"conflict_resolution": {}, "dependencies": [{"coord": "aopalliance:aopalliance:1.0", "file": "v1/https/repo1.maven.org/maven2/aopalliance/aopalliance/1.0/aopalliance-1.0.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/aopalliance/aopalliance/1.0/aopalliance-1.0.jar", "mirror_urls": ["https://repo1.maven.org/maven2/aopalliance/aopalliance/1.0/aopalliance-1.0.jar"], "sha256": "0addec670fedcd3f113c5c8091d783280d23f75e3acb841b61a9cdb079376a08"}, {"coord": "aopalliance:aopalliance:jar:sources:1.0", "file": "v1/https/repo1.maven.org/maven2/aopalliance/aopalliance/1.0/aopalliance-1.0-sources.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/aopalliance/aopalliance/1.0/aopalliance-1.0-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/aopalliance/aopalliance/1.0/aopalliance-1.0-sources.jar"], "sha256": "e6ef91d439ada9045f419c77543ebe0416c3cdfc5b063448343417a3e4a72123"}, {"coord": "com.beust:jcommander:1.72", "file": "v1/https/repo1.maven.org/maven2/com/beust/jcommander/1.72/jcommander-1.72.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/com/beust/jcommander/1.72/jcommander-1.72.jar", "mirror_urls": ["https://repo1.maven.org/maven2/com/beust/jcommander/1.72/jcommander-1.72.jar"], "sha256": "e0de160b129b2414087e01fe845609cd55caec6820cfd4d0c90fabcc7bdb8c1e"}, {"coord": "com.beust:jcommander:jar:sources:1.72", "file": "v1/https/repo1.maven.org/maven2/com/beust/jcommander/1.72/jcommander-1.72-sources.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/com/beust/jcommander/1.72/jcommander-1.72-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/com/beust/jcommander/1.72/jcommander-1.72-sources.jar"], "sha256": "9b4fddc257d3572696333f48158802243141ce46579d92f0a4c0b2c14956b49d"}, {"coord": "com.google.guava:guava:19.0", "file": "v1/https/repo1.maven.org/maven2/com/google/guava/guava/19.0/guava-19.0.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/com/google/guava/guava/19.0/guava-19.0.jar", "mirror_urls": ["https://repo1.maven.org/maven2/com/google/guava/guava/19.0/guava-19.0.jar"], "sha256": "58d4cc2e05ebb012bbac568b032f75623be1cb6fb096f3c60c72a86f7f057de4"}, {"coord": "com.google.guava:guava:jar:sources:19.0", "file": "v1/https/repo1.maven.org/maven2/com/google/guava/guava/19.0/guava-19.0-sources.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/com/google/guava/guava/19.0/guava-19.0-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/com/google/guava/guava/19.0/guava-19.0-sources.jar"], "sha256": "814e1ebf708d38c3b00155fbd484a401a6f771b512862e4bf58863c4f9563c6a"}, {"coord": "com.google.inject:guice:jar:no_aop:4.1.0", "file": "v1/https/repo1.maven.org/maven2/com/google/inject/guice/4.1.0/guice-4.1.0-no_aop.jar", "directDependencies": ["aopalliance:aopalliance:1.0", "com.google.guava:guava:19.0", "javax.inject:javax.inject:1"], "dependencies": ["aopalliance:aopalliance:1.0", "javax.inject:javax.inject:1", "com.google.guava:guava:19.0"], "url": "https://repo1.maven.org/maven2/com/google/inject/guice/4.1.0/guice-4.1.0-no_aop.jar", "mirror_urls": ["https://repo1.maven.org/maven2/com/google/inject/guice/4.1.0/guice-4.1.0-no_aop.jar"], "sha256": "9264c6931c431e928dc64adc842584d5f57d17b2f3aff29221f2b3fdea673dad"}, {"coord": "com.google.inject:guice:jar:sources:4.1.0", "file": "v1/https/repo1.maven.org/maven2/com/google/inject/guice/4.1.0/guice-4.1.0-sources.jar", "directDependencies": ["aopalliance:aopalliance:jar:sources:1.0", "com.google.guava:guava:jar:sources:19.0", "javax.inject:javax.inject:jar:sources:1"], "dependencies": ["aopalliance:aopalliance:jar:sources:1.0", "com.google.guava:guava:jar:sources:19.0", "javax.inject:javax.inject:jar:sources:1"], "url": "https://repo1.maven.org/maven2/com/google/inject/guice/4.1.0/guice-4.1.0-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/com/google/inject/guice/4.1.0/guice-4.1.0-sources.jar"], "sha256": "1a6fc6f00fdbc39857ef2815bcd7d1ff0f0fad6459dc686d8bfba7f4bea29b6f"}, {"coord": "javax.inject:javax.inject:1", "file": "v1/https/repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1.jar", "mirror_urls": ["https://repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1.jar"], "sha256": "91c77044a50c481636c32d916fd89c9118a72195390452c81065080f957de7ff"}, {"coord": "javax.inject:javax.inject:jar:sources:1", "file": "v1/https/repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1-sources.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/javax/inject/javax.inject/1/javax.inject-1-sources.jar"], "sha256": "c4b87ee2911c139c3daf498a781967f1eb2e75bc1a8529a2e7b328a15d0e433e"}, {"coord": "junit:junit:4.12", "file": "v1/https/repo1.maven.org/maven2/junit/junit/4.12/junit-4.12.jar", "directDependencies": ["org.hamcrest:hamcrest-core:1.3"], "dependencies": ["org.hamcrest:hamcrest-core:1.3"], "url": "https://repo1.maven.org/maven2/junit/junit/4.12/junit-4.12.jar", "mirror_urls": ["https://repo1.maven.org/maven2/junit/junit/4.12/junit-4.12.jar"], "sha256": "59721f0805e223d84b90677887d9ff567dc534d7c502ca903c0c2b17f05c116a"}, {"coord": "junit:junit:jar:sources:4.12", "file": "v1/https/repo1.maven.org/maven2/junit/junit/4.12/junit-4.12-sources.jar", "directDependencies": ["org.hamcrest:hamcrest-core:jar:sources:1.3"], "dependencies": ["org.hamcrest:hamcrest-core:jar:sources:1.3"], "url": "https://repo1.maven.org/maven2/junit/junit/4.12/junit-4.12-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/junit/junit/4.12/junit-4.12-sources.jar"], "sha256": "9f43fea92033ad82bcad2ae44cec5c82abc9d6ee4b095cab921d11ead98bf2ff"}, {"coord": "org.hamcrest:hamcrest-core:1.3", "file": "v1/https/repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar", "mirror_urls": ["https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar"], "sha256": "66fdef91e9739348df7a096aa384a5685f4e875584cce89386a7a47251c4d8e9"}, {"coord": "org.hamcrest:hamcrest-core:jar:sources:1.3", "file": "v1/https/repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3-sources.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3-sources.jar"], "sha256": "e223d2d8fbafd66057a8848cc94222d63c3cedd652cc48eddc0ab5c39c0f84df"}, {"coord": "org.testng:testng:7.1.0", "file": "v1/https/repo1.maven.org/maven2/org/testng/testng/7.1.0/testng-7.1.0.jar", "directDependencies": ["com.beust:jcommander:1.72", "com.google.inject:guice:jar:no_aop:4.1.0", "org.yaml:snakeyaml:1.21"], "dependencies": ["org.yaml:snakeyaml:1.21", "aopalliance:aopalliance:1.0", "com.google.guava:guava:19.0", "javax.inject:javax.inject:1", "com.google.inject:guice:jar:no_aop:4.1.0", "com.beust:jcommander:1.72"], "url": "https://repo1.maven.org/maven2/org/testng/testng/7.1.0/testng-7.1.0.jar", "mirror_urls": ["https://repo1.maven.org/maven2/org/testng/testng/7.1.0/testng-7.1.0.jar"], "sha256": "e968e6cc3e925fe09b7b841d379e230dd9c56d6850ce18cf9a8e78ac0ce8e1b7"}, {"coord": "org.testng:testng:jar:sources:7.1.0", "file": "v1/https/repo1.maven.org/maven2/org/testng/testng/7.1.0/testng-7.1.0-sources.jar", "directDependencies": ["com.beust:jcommander:jar:sources:1.72", "com.google.inject:guice:jar:sources:4.1.0", "org.yaml:snakeyaml:jar:sources:1.21"], "dependencies": ["aopalliance:aopalliance:jar:sources:1.0", "javax.inject:javax.inject:jar:sources:1", "com.google.inject:guice:jar:sources:4.1.0", "com.beust:jcommander:jar:sources:1.72", "org.yaml:snakeyaml:jar:sources:1.21", "com.google.guava:guava:jar:sources:19.0"], "url": "https://repo1.maven.org/maven2/org/testng/testng/7.1.0/testng-7.1.0-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/org/testng/testng/7.1.0/testng-7.1.0-sources.jar"], "sha256": "a5a11e8c63ff91a302c298a655aad3fe87cabd335450c09fb709199aacf9a60e"}, {"coord": "org.yaml:snakeyaml:1.21", "file": "v1/https/repo1.maven.org/maven2/org/yaml/snakeyaml/1.21/snakeyaml-1.21.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/org/yaml/snakeyaml/1.21/snakeyaml-1.21.jar", "mirror_urls": ["https://repo1.maven.org/maven2/org/yaml/snakeyaml/1.21/snakeyaml-1.21.jar"], "sha256": "e43cb0683f70804b833dfaa5ac032ff14ba0c758d4a1e9eaeb6640515df83faf"}, {"coord": "org.yaml:snakeyaml:jar:sources:1.21", "file": "v1/https/repo1.maven.org/maven2/org/yaml/snakeyaml/1.21/snakeyaml-1.21-sources.jar", "directDependencies": [], "dependencies": [], "url": "https://repo1.maven.org/maven2/org/yaml/snakeyaml/1.21/snakeyaml-1.21-sources.jar", "mirror_urls": ["https://repo1.maven.org/maven2/org/yaml/snakeyaml/1.21/snakeyaml-1.21-sources.jar"], "sha256": "c3e778d791f7af1a5c10e0624471c1eb70201c2441390bf62099ff390a319e7d"}], "version": "0.1.0", "__AUTOGENERATED_FILE_DO_NOT_MODIFY_THIS_FILE_MANUALLY": 1239198019}}
RULES_JVM_EXTERNAL_EOF

if [ "False" = "True" ]; then
    echo "Successfully pinned resolved artifacts for @maven, $maven_install_json_loc is now up-to-date."
else
    echo "Successfully pinned resolved artifacts for @maven in $maven_install_json_loc." \
      "This file should be checked in your version control system."
    echo
    echo "Next, please update your WORKSPACE file by adding the maven_install_json attribute" \
      "and loading pinned_maven_install from @maven//:defs.bzl".
    echo
    echo "For example:"
    echo
    cat <<EOF
=============================================================

maven_install(
    artifacts = # ...,
    repositories = # ...,
    maven_install_json = "@$workspace_name//:maven_install.json",
)

load("@maven//:defs.bzl", "pinned_maven_install")
pinned_maven_install()

=============================================================
EOF

    echo
    echo "To update maven_install.json, run this command to re-pin the unpinned repository:"
    echo
    echo "    bazel run @unpinned_maven//:pin"
fi
echo
